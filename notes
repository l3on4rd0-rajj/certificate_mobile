
import pandas as pd
import requests
from datetime import datetime

# Caminho do arquivo Excel com colunas 'produto' e 'versao'
excel_path = "caminho_para_sua_planilha.xlsx"

# Carregar a planilha
df = pd.read_excel(excel_path)

# Lista para armazenar os resultados
resultados = []

# Função para consultar a API do endoflife.date
def verificar_suporte(produto, versao):
    url = f"https://endoflife.date/api/{produto}.json"
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code != 200:
            return {"status": "Produto não encontrado", "eol": None, "latest": None}

        ciclos = resp.json()
        for ciclo in ciclos:
            if str(ciclo["cycle"]) == str(versao):
                eol_data = ciclo.get("eol")
                latest = ciclo.get("latest", "")
                if eol_data and eol_data != "false":
                    eol_date = datetime.strptime(eol_data, "%Y-%m-%d")
                    ainda_em_suporte = eol_date > datetime.today()
                else:
                    ainda_em_suporte = True
                    eol_date = None
                return {
                    "status": "Em suporte" if ainda_em_suporte else "EOL",
                    "eol": eol_date.strftime("%Y-%m-%d") if eol_date else "Sem EOL",
                    "latest": latest
                }
        return {"status": "Versão não encontrada", "eol": None, "latest": None}
    except Exception as e:
        return {"status": f"Erro: {e}", "eol": None, "latest": None}

# Aplicar a verificação a cada linha
for _, row in df.iterrows():
    produto = str(row["produto"]).strip().lower()
    versao = str(row["versao"]).strip()
    resultado = verificar_suporte(produto, versao)
    resultados.append({
        "produto": produto,
        "versao": versao,
        "status": resultado["status"],
        "eol": resultado["eol"],
        "ultima_versao": resultado["latest"]
    })

# Criar DataFrame e salvar resultado
df_resultado = pd.DataFrame(resultados)
df_resultado.to_excel("resultado_endoflife.xlsx", index=False)
print("✅ Resultado salvo como 'resultado_endoflife.xlsx'")
