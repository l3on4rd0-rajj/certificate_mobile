import os
import re
import json

# Altere este caminho para o diretório onde está o seu projeto C
PROJECT_DIR = r"C:\Users\SeuUsuario\projetos\meu_projeto_c"

INCLUDE_REGEX = re.compile(r'#include\s+[<"](.+?)[>"]')

libraries = {}

def scan_c_files():
    for root, _, files in os.walk(PROJECT_DIR):
        for file in files:
            if file.endswith(('.c', '.h')):
                with open(os.path.join(root, file), 'r', errors='ignore') as f:
                    content = f.read()
                    includes = INCLUDE_REGEX.findall(content)
                    for inc in includes:
                        if inc not in libraries:
                            lib_info = {
                                "name": inc,
                                "version": "unknown",
                                "type": "local_or_system" if "/" not in inc else "project_or_third_party"
                            }
                            libraries[inc] = lib_info

def generate_sbom():
    sbom = {
        "project": os.path.basename(PROJECT_DIR),
        "environment": "Windows",
        "libraries": list(libraries.values())
    }
    with open("sbom_windows.json", "w") as f:
        json.dump(sbom, f, indent=4)
    print("✅ SBOM salvo como sbom_windows.json")

if __name__ == "__main__":
    scan_c_files()
    generate_sbom()
