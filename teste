import streamlit as st
import pandas as pd
import plotly.express as px
from io import BytesIO


# Função para carregar e preparar os dados
def load_and_prepare_data(file):
    try:
        # Carregar o arquivo Excel
        df = pd.read_excel(file)

        # Padronizar os nomes das colunas
        df.columns = df.columns.str.strip().str.lower()

        # Colunas obrigatórias
        required_columns = ['projetos', 'departament', 'fortifyonboardedstatus', 
                            'critical', 'high', 'medium', 'low']

        # Verificar se todas as colunas obrigatórias estão presentes
        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            st.error(f"As seguintes colunas estão ausentes no arquivo: {', '.join(missing_columns)}")
            return None

        # Garantir que as colunas numéricas contenham valores válidos
        numeric_columns = ['critical', 'high', 'medium', 'low']
        for col in numeric_columns:
            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0).astype(int)

        # Calcular total de vulnerabilidades
        df['total vulnerabilidades'] = df['critical'] + df['high'] + df['medium'] + df['low']

        # Proporção de vulnerabilidades severas (críticas e altas)
        df['proporcao severas'] = (df['critical'] + df['high']) / df['total vulnerabilidades']
        df['proporcao severas'] = df['proporcao severas'].fillna(0)  # Evitar divisões por zero

        # Extrair nome base do projeto
        df['projeto base'] = df['projetos'].apply(lambda x: x.split('-')[0] if isinstance(x, str) else x)

        return df

    except Exception as e:
        st.error(f"Erro ao processar o arquivo: {e}")
        return None


# Função para criar gráficos e dashboards
def create_dashboards(df):
    st.title("Dashboard Avançado de Vulnerabilidades")

    # Filtro por departamento
    st.sidebar.subheader("Filtros")
    selected_department = st.sidebar.selectbox("Selecione um Departamento", 
                                                options=["Todos"] + df['departament'].unique().tolist())
    if selected_department != "Todos":
        df = df[df['departament'] == selected_department]

    # Gráfico: Ranking de projetos mais vulneráveis
    st.header("Ranking de Projetos Mais Vulneráveis")
    top_vulnerable_projects = df.nlargest(10, 'total vulnerabilidades')
    fig_top_projects = px.bar(top_vulnerable_projects, x='projetos', y='total vulnerabilidades', 
                               title="Top 10 Projetos Mais Vulneráveis", text='total vulnerabilidades')
    fig_top_projects.update_traces(textposition='outside')
    st.plotly_chart(fig_top_projects)

    # Gráfico: Comparativo de severidade total
    st.header("Comparativo de Vulnerabilidades por Severidade")
    severity_totals = df[['critical', 'high', 'medium', 'low']].sum().reset_index()
    severity_totals.columns = ['severidade', 'total']
    fig_severity = px.bar(severity_totals, x='severidade', y='total', 
                          title="Total de Vulnerabilidades por Severidade", text='total')
    fig_severity.update_traces(textposition='outside')
    st.plotly_chart(fig_severity)

    # Gráfico: Proporção de vulnerabilidades severas por projeto
    st.header("Proporção de Vulnerabilidades Severas por Projeto")
    severe_ratio = df[['projetos', 'proporcao severas']].sort_values('proporcao severas', ascending=False).head(10)
    fig_severe_ratio = px.bar(severe_ratio, x='projetos', y='proporcao severas', 
                              title="Projetos com Maior Proporção de Vulnerabilidades Severas",
                              text='proporcao severas')
    fig_severe_ratio.update_traces(textposition='outside')
    st.plotly_chart(fig_severe_ratio)

    # Gráfico: Projetos deployados por departamento
    st.header("Total de Projetos Deployados por Departamento")
    deployed_projects = df[df['fortifyonboardedstatus'].str.lower() == 'deployed']
    deploy_by_department = deployed_projects['departament'].value_counts().reset_index()
    deploy_by_department.columns = ['departamento', 'total projetos deployados']
    fig_deploy_dept = px.bar(deploy_by_department, x='departamento', y='total projetos deployados',
                             title="Projetos Deployados por Departamento", text='total projetos deployados')
    fig_deploy_dept.update_traces(textposition='outside')
    st.plotly_chart(fig_deploy_dept)

    # Tabela: Projetos não deployados
    st.header("Projetos Não Deployados")
    not_deployed = df[df['fortifyonboardedstatus'].str.lower() != 'deployed']
    st.write(not_deployed)


# Função para gerar relatório Excel
def generate_excel(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        df.to_excel(writer, index=False, sheet_name="Vulnerabilidades")
    processed_data = output.getvalue()
    return processed_data


# App Principal
def main():
    # Configurações do sidebar
    st.sidebar.title("Upload de Arquivo")
    uploaded_file = st.sidebar.file_uploader("Carregue um arquivo Excel", type=["xlsx"])

    # Carregar e processar os dados
    if uploaded_file:
        data = load_and_prepare_data(uploaded_file)

        if data is not None:
            # Criar os dashboards
            create_dashboards(data)

            # Botão para download do relatório
            st.sidebar.subheader("Download do Relatório")
            excel_data = generate_excel(data)
            st.sidebar.download_button(label="Baixar Relatório Excel",
                                        data=excel_data,
                                        file_name="relatorio_vulnerabilidades.xlsx")
    else:
        st.write("Por favor, carregue um arquivo Excel para visualizar os dashboards.")


# Executar o app
if __name__ == "__main__":
    main()
