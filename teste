def load_and_validate_data(file):
    try:
        # Carregar o arquivo Excel
        df = pd.read_excel(file)

        # Padronizar os nomes das colunas
        df.columns = df.columns.str.strip().str.lower()

        # Definir os nomes esperados das colunas
        required_columns = ['projetos', 'departament', 'fortifyonboardedstatus', 
                            'critical', 'high', 'medium', 'low']

        # Verificar se todas as colunas obrigatórias estão presentes
        for col in required_columns:
            if col not in df.columns:
                st.error(f"Coluna obrigatória ausente no arquivo: {col}")
                return None

        # Converter colunas de vulnerabilidades para números
        numeric_columns = ['critical', 'high', 'medium', 'low']
        for col in numeric_columns:
            df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0).astype(int)

        # Calcular total de vulnerabilidades
        df['total vulnerabilidades'] = df['critical'] + df['high'] + df['medium'] + df['low']

        # Extrair nome base do projeto
        df['projeto base'] = df['projetos'].apply(lambda x: x.split('-')[0] if isinstance(x, str) else x)
        
        return df

    except Exception as e:
        st.error(f"Erro ao processar o arquivo: {e}")
        return None
